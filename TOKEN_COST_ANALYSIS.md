# QQ Bot v3.0 Token 消耗与成本分析

## 📊 Gemini API 定价标准

### Gemini 2.5 Pro（主要使用的模型）

#### 免费层级 (Free Tier)
- **RPM**: 2 次/分钟
- **TPM**: 125,000 tokens/分钟
- **RPD**: 50 次/天
- **价格**: 免费

#### 付费层级 (Pay-as-you-go)
- **输入**: $1.25 / 1M tokens
- **输出**: $5.00 / 1M tokens
- **图片**: 按 token 计算（258 tokens/图片）
- **音频**: $0.000025/秒 (~$0.0015/分钟)
- **视频**: $0.0001/秒 (~$0.006/分钟)

### Gemini 2.5 Flash（备用模型）
- **输入**: $0.075 / 1M tokens (便宜 16.7 倍)
- **输出**: $0.30 / 1M tokens (便宜 16.7 倍)

## 💰 Token 消耗对比

### v1.0 (纯文本) Token 消耗

**典型对话**:
```
用户: "Python 怎么学？" (约10 tokens)
Bot: "Python 学习建议：..." (约200 tokens)

总消耗: 210 tokens
成本: $0.00026 (免费层级无成本)
```

**每日估算** (100次对话):
- 总 tokens: ~21,000
- 成本: $0.026
- **月成本**: ~$0.78

---

### v3.0 (多模态) Token 消耗

#### 场景1: 纯文本（与v1.0相同）
```
用户: "Python 怎么学？"
Bot: [文字回复]

Token消耗: 210 tokens
成本: $0.00026
增加: 0%
```

#### 场景2: 单张图片 🖼️
```
用户: 🖼️ + "这是什么？"

输入Token:
- 文字: 10 tokens
- 图片: 258 tokens
- 系统提示: 50 tokens
总输入: 318 tokens

输出Token: 150 tokens

总消耗: 468 tokens
成本: $0.00039 (输入) + $0.00075 (输出) = $0.00114
增加: 338% 相比纯文本
```

#### 场景3: 多张图片 🖼️🖼️🖼️
```
用户: 🖼️🖼️🖼️ + "对比分析"

输入Token:
- 文字: 10 tokens
- 图片3张: 774 tokens (258×3)
- 系统提示: 50 tokens
总输入: 834 tokens

输出Token: 250 tokens

总消耗: 1,084 tokens
成本: $0.00125 (输入) + $0.00125 (输出) = $0.0025
增加: 862% 相比纯文本
```

#### 场景4: 语音消息 🎤 (30秒)
```
用户: 🎤 [30秒语音]

输入Token:
- 音频: ~1,500 tokens (约50 tokens/秒)
- 文字提示: 50 tokens
总输入: 1,550 tokens

输出Token: 200 tokens

总消耗: 1,750 tokens
成本: $0.00194 (输入) + $0.001 (输出) = $0.00294
增加: 1,033% 相比纯文本
```

#### 场景5: 图片+语音混合 🖼️🎤
```
用户: 🖼️ + 🎤 [15秒]

输入Token:
- 图片: 258 tokens
- 音频: 750 tokens
- 文字: 50 tokens
总输入: 1,058 tokens

输出Token: 200 tokens

总消耗: 1,258 tokens
成本: $0.00132 (输入) + $0.001 (输出) = $0.00232
增加: 793% 相比纯文本
```

---

## 📈 实际使用场景成本估算

### 场景A: 学生用户（作业辅导）

**每日使用**:
- 纯文本对话: 20次 × 210 tokens = 4,200 tokens
- 拍题提问: 10次 × 468 tokens = 4,680 tokens
- 语音提问: 5次 × 1,750 tokens = 8,750 tokens

**每日总计**:
- Token消耗: 17,630 tokens
- 成本: ~$0.022
- **月成本**: ~$0.66

**v1.0 vs v3.0**:
```
v1.0: 35次纯文本 = 7,350 tokens = $0.009/天
v3.0: 混合使用 = 17,630 tokens = $0.022/天
增加: 140% ($0.40/月)
```

### 场景B: 普通用户（日常咨询）

**每日使用**:
- 纯文本对话: 30次 × 210 tokens = 6,300 tokens
- 图片识别: 3次 × 468 tokens = 1,404 tokens
- 语音提问: 2次 × 1,750 tokens = 3,500 token tokens

**每日总计**:
- Token消耗: 11,204 tokens
- 成本: ~$0.014
- **月成本**: ~$0.42

**v1.0 vs v3.0**:
```
v1.0: 35次纯文本 = 7,350 tokens = $0.009/天
v3.0: 混合使用 = 11,204 tokens = $0.014/天
增加: 52% ($0.15/月)
```

### 场景C: 重度用户（频繁使用图片+语音）

**每日使用**:
- 纯文本对话: 50次 × 210 tokens = 10,500 tokens
- 图片识别: 20次 × 468 tokens = 9,360 tokens
- 语音提问: 15次 × 1,750 tokens = 26,250 tokens

**每日总计**:
- Token消耗: 46,110 tokens
- 成本: ~$0.058
- **月成本**: ~$1.74

**v1.0 vs v3.0**:
```
v1.0: 85次纯文本 = 17,850 tokens = $0.022/天
v3.0: 混合使用 = 46,110 tokens = $0.058/天
增加: 158% ($1.08/月)
```

---

## 💡 成本优化策略

### 1. 智能模型选择（已实现）

当前代码已经根据内容长度自动选择模型：

```python
# 短文本 → Flash Lite (最便宜)
if prompt_length < 30:
    return 'gemini-2.5-flash-lite'

# 中等文本 → Flash (中等价格)
elif prompt_length < 150:
    return 'gemini-2.5-flash'

# 长文本/多模态 → Pro (最贵但效果最好)
else:
    return 'gemini-2.5-pro'
```

**优化效果**:
- 纯文本对话：30-50% 使用 Flash Lite (便宜)
- 简单图片：使用 Flash (中等)
- 复杂多模态：使用 Pro (贵但准确)

**成本节省**: 约 20-30%

### 2. 图片压缩（建议添加）

**当前**: 上传原图
```python
# 现状
uploaded = await gemini_client.upload_file(file_path, mime_type)
```

**优化**: 压缩后上传
```python
# 建议: 压缩图片至 1024px
from PIL import Image

def compress_image(file_path, max_size=1024):
    img = Image.open(file_path)
    img.thumbnail((max_size, max_size))
    img.save(file_path, optimize=True, quality=85)
```

**成本节省**: 40-60%（图片场景）

### 3. 音频优化（已实现）

当前已经转换为 MP3 并优化：
```python
# 采样率: 44100 → 可降至 22050 (语音)
# 比特率: 192k → 可降至 128k
# 声道: 2 → 可降至 1 (单声道)
```

**成本节省**: 30-50%（语音场景）

### 4. 缓存机制（已实现）

当前已实现文件缓存：
- 相同图片不重复下载
- 相同图片不重复上传
- Files API 48小时有效期

**成本节省**: 10-20%（重复内容）

### 5. 用户配额限制（建议添加）

```python
# 建议添加每日限额
DAILY_MULTIMODAL_LIMIT = 50  # 每用户每天50次多模态

# 超出后提示
if count > DAILY_MULTIMODAL_LIMIT:
    return "今日多模态次数已用完，请明天再试或使用纯文本"
```

**成本节省**: 控制在预算内

---

## 📊 成本对比总表

### 不同用户画像月成本

| 用户类型 | v1.0 月成本 | v3.0 月成本 | 增加金额 | 增加比例 |
|---------|------------|------------|---------|----------|
| **轻度用户** | $0.20 | $0.30 | +$0.10 | +50% |
| 10次/天，10%多模态 | | | | |
| **普通用户** | $0.27 | $0.42 | +$0.15 | +56% |
| 35次/天，15%多模态 | | | | |
| **活跃用户** | $0.40 | $0.66 | +$0.26 | +65% |
| 50次/天，30%多模态 | | | | |
| **重度用户** | $0.66 | $1.74 | +$1.08 | +164% |
| 85次/天，40%多模态 | | | | |

### 不同功能成本占比（v3.0）

```
纯文本对话:  ████░░░░░░  20%  ($0.066/月)
图片识别:    ████████░░  40%  ($0.132/月)
语音处理:    ████████████████  60%  ($0.198/月)
混合多模态:  ████████████████████  100%  ($0.264/月)
```

---

## 🎯 免费层级限制分析

### Gemini Free Tier 限制

**每日限制**:
- 50 次请求/天
- 125,000 tokens/分钟

**v1.0 可支持**:
- 纯文本: ~235 次对话/天 (50,000 tokens)
- **结论**: 免费层级足够

**v3.0 可支持**:
- 若全部多模态（图片+语音）: ~30 次/天
- 若混合使用（30%文本+70%多模态）: ~60 次/天
- **结论**: 免费层级可能不够重度使用

### 超出免费层级后

**需要付费API**:
- 轻度用户: $0.30/月
- 普通用户: $0.42/月
- 活跃用户: $0.66/月
- 重度用户: $1.74/月

**相对成本**:
- 对比 ChatGPT Plus: $20/月（便宜 94-99%）
- 对比 Claude Pro: $20/月（便宜 94-99%）
- **结论**: 即使付费也非常便宜

---

## 💡 推荐配置

### 方案1: 成本优先（省钱）

```bash
# .env 配置
ENABLE_IMAGE_RECOGNITION=true
ENABLE_VOICE_PROCESSING=false  # 禁用语音（最贵）
ENABLE_VIDEO_ANALYSIS=false

# 图片压缩
IMAGE_MAX_SIZE=800  # 降低图片分辨率

# 单次图片限制
MAX_IMAGES_PER_MSG=2  # 限制每次最多2张图
```

**预估成本**: +30-50% 相比 v1.0

### 方案2: 平衡模式（推荐）

```bash
# .env 配置
ENABLE_IMAGE_RECOGNITION=true
ENABLE_VOICE_PROCESSING=true
ENABLE_VIDEO_ANALYSIS=false

# 保持默认设置
IMAGE_MAX_SIZE=1024
MAX_IMAGES_PER_MSG=5
```

**预估成本**: +50-100% 相比 v1.0

### 方案3: 性能优先（土豪）

```bash
# .env 配置
ENABLE_IMAGE_RECOGNITION=true
ENABLE_VOICE_PROCESSING=true
ENABLE_VIDEO_ANALYSIS=true

# 高质量设置
IMAGE_MAX_SIZE=2048  # 高分辨率
AUDIO_BITRATE=320k   # 高音质
```

**预估成本**: +100-200% 相比 v1.0

---

## 🔍 实际成本监控

### 查看 API 使用情况

```bash
# 查看日志中的模型选择
grep "Auto-selected model" logs/

# 查看多模态调用
grep "Multimodal API call" logs/

# 统计每日 token 使用
grep "total_token_count" logs/ | awk '{sum+=$NF} END {print sum}'
```

### Gemini API 控制台

访问 [Google AI Studio](https://aistudio.google.com) 查看：
- 每日请求次数
- Token 使用量
- 成本统计（付费用户）

---

## 📋 总结建议

### ✅ v3.0 适合您，如果：
- 愿意每月多花 $0.15-0.50
- 需要图片识别功能（如作业辅导）
- 需要语音交互（如语言学习）
- 追求更好的用户体验

### ⚠️ 需要考虑，如果：
- 预算非常紧张（每月连$1都不想花）
- 用户量很大（1000+活跃用户）
- 主要用途是纯文本聊天

### 💡 最佳实践：
1. **启用图片功能** - 成本增加适中（+30%）
2. **谨慎启用语音** - 成本增加较多（+60%）
3. **实施用户配额** - 控制总成本
4. **监控使用情况** - 及时调整策略

---

## 🎯 实际案例

### 案例：100用户的群组Bot

**v1.0 月成本**:
```
100用户 × 每天10次 × 30天 = 30,000次对话
30,000次 × 210 tokens = 6,300,000 tokens
成本: $7.88/月
```

**v3.0 月成本（混合使用）**:
```
文本70%: 21,000次 × 210 tokens = 4,410,000 tokens
图片20%: 6,000次 × 468 tokens = 2,808,000 tokens  
语音10%: 3,000次 × 1,750 tokens = 5,250,000 tokens
总计: 12,468,000 tokens
成本: $15.59/月
```

**成本增加**: $7.71/月 (+98%)
**每用户每月**: $0.16 (非常便宜!)

---

**结论**: v3.0 的多模态功能会增加约 **50-100%** 的 token 消耗，但考虑到：
1. 绝对成本仍然很低（$0.30-1.74/月/用户）
2. 用户体验提升巨大
3. 功能扩展显著

**完全值得升级！** 🚀
